<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Turn-Based Grid Game</title>
        <link rel="stylesheet" href="style.css"<!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Strategy Game - Lobby</title>
          <link rel="stylesheet" href="styles.css">
        </head>
        <body>
          <div class="container">
            <h1>ðŸŽ® Turn-Based Strategy Game</h1>

            <div id="login-section" class="section">
              <h2>Enter Your Name</h2>
              <input type="text" id="player-name" placeholder="Enter your name" maxlength="20">
              <button id="register-btn" class="btn btn-primary">Start Playing</button>
            </div>

            <div id="lobby-section" class="section hidden">
              <h2>Welcome, <span id="welcome-name"></span>!</h2>

              <div class="lobby-actions">
                <button id="create-game-btn" class="btn btn-success">Create New Game</button>
                <button id="refresh-games-btn" class="btn btn-secondary">Refresh Games</button>
              </div>

              <div class="available-games">
                <h3>Available Games</h3>
                <div id="games-list">
                  <p class="no-games">No games available. Create one!</p>
                </div>
              </div>
            </div>
          </div>

          <script>
            let playerId = null;
            let playerName = null;

            // Check if player is already registered
            const savedPlayerId = localStorage.getItem('playerId');
            if (savedPlayerId) {
              fetch(`/api/player/${savedPlayerId}`)
                .then(res => res.json())
                .then(data => {
                  if (data.success) {
                    playerId = savedPlayerId;
                    playerName = data.player.name;
                    showLobby();
                  }
                })
                .catch(() => {
                  localStorage.removeItem('playerId');
                });
            }

            document.getElementById('register-btn').addEventListener('click', async () => {
              const name = document.getElementById('player-name').value.trim();

              if (!name) {
                alert('Please enter your name');
                return;
              }

              try {
                const response = await fetch('/api/auth/register', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ name })
                });

                const data = await response.json();

                if (data.success) {
                  playerId = data.playerId;
                  playerName = data.name;
                  localStorage.setItem('playerId', playerId);
                  showLobby();
                } else {
                  alert('Registration failed');
                }
              } catch (error) {
                console.error('Error:', error);
                alert('Failed to register');
              }
            });

            document.getElementById('create-game-btn').addEventListener('click', async () => {
              try {
                const response = await fetch('/api/game/create', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ playerId })
                });

                const data = await response.json();

                if (data.success) {
                  window.location.href = `game.html?gameId=${data.gameId}&playerId=${playerId}`;
                } else {
                  alert('Failed to create game');
                }
              } catch (error) {
                console.error('Error:', error);
                alert('Failed to create game');
              }
            });

            document.getElementById('refresh-games-btn').addEventListener('click', loadAvailableGames);

            async function loadAvailableGames() {
              try {
                const response = await fetch('/api/game/available');
                const data = await response.json();

                const gamesList = document.getElementById('games-list');

                if (data.games.length === 0) {
                  gamesList.innerHTML = '<p class="no-games">No games available. Create one!</p>';
                  return;
                }

                gamesList.innerHTML = data.games.map(game => `
                  <div class="game-item">
                    <span class="game-host">${game.host}'s Game</span>
                    <button class="btn btn-primary btn-sm" onclick="joinGame('${game.gameId}')">Join</button>
                  </div>
                `).join('');
              } catch (error) {
                console.error('Error:', error);
              }
            }

            async function joinGame(gameId) {
              try {
                const response = await fetch('/api/game/join', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ gameId, playerId })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                  window.location.href = `game.html?gameId=${gameId}&playerId=${playerId}`;
                } else {
                  alert(data.error || 'Failed to join game');
                }
              } catch (error) {
                console.error('Error:', error);
                alert('Failed to join game');
              }
            }

            function showLobby() {
              document.getElementById('login-section').classList.add('hidden');
              document.getElementById('lobby-section').classList.remove('hidden');
              document.getElementById('welcome-name').textContent = playerName;
              loadAvailableGames();
            }

            // Allow Enter key to register
            document.getElementById('player-name').addEventListener('keypress', (e) => {
              if (e.key === 'Enter') {
                document.getElementById('register-btn').click();
              }
            });
          </script>
        </body>
        </html> />
    </head>
    <body>
        <h1>Turn-Based Grid Game</h1>
        <div id="board"></div>
        <div id="controls">
            <button data-dir="up">Up</button>
            <button data-dir="down">Down</button>
            <button data-dir="left">Left</button>
            <button data-dir="right">Right</button>
        </div>
        <script src="game.js"></script>
    </body>
</html>
